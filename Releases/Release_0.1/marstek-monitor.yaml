# FOR MARSTEK v0.1 HW VERSION ONLY.
# NOT A STABLE VERSION
# THIS VERSION HAS KNOWN ISSUES, USE AT OWN RISK

#Only applicable to LilyGo T-Display V1.1 ESP32 devboard
esphome:
  name: marstek-monitor
  friendly_name: marstek-monitor

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:
   level: INFO
   baud_rate: 0

# Enable Home Assistant API
api:
  encryption:
    key: !secret marstek_api_key

ota:
  - platform: esphome
    password: !secret marstek_ota_key

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Marstek-Monitor2"
    password: "marstekMon"

#captive_portal:
  #leeg

web_server:
  local: true
  port: 80
    
# Include custom fonts
font:
  - file: "gfonts://Roboto"
    id: roboto
    size: 26

  - file: "gfonts://Roboto"
    id: roboto_small
    size: 14

#Display backlight
output:
  - platform: ledc
    pin: 4
    id: gpio_04_backlight_pwm

light:
  - platform: monochromatic
    output: gpio_04_backlight_pwm
    name: "Display Backlight"
    id: back_light
    restore_mode: ALWAYS_ON

# Define colors
color:
  - id: red
    red: 100%
    green: 0%
    blue: 0%
    white: 0%

  - id: green
    red: 0%
    green: 100%
    blue: 0%
    white: 0%

# Pins for Onboard display
spi:
  clk_pin: GPIO18
  mosi_pin: GPIO19

interval:
  - interval: 3s
    then:
      - display.page.show_next: shottimer_display
      - component.update: shottimer_display    

# render on the screen.
display:
  - platform: st7789v
    id: shottimer_display
    cs_pin: GPIO5
    dc_pin: GPIO16
    reset_pin: GPIO23
    backlight_pin: no
    model: TTGO TDisplay 135x240
    rotation: 90°
    pages:
      - id: page1
        lambda: |-
          it.printf(0, 40, id(roboto), "State of Charge");
          it.printf(0, 65, id(roboto), "%.0f  %%", id(marstek_soc).state);
      - id: page2
        lambda: |-
          it.printf(0, 20, id(roboto), "Battery state");
          it.printf(0, 45, id(roboto), "%s", id(marstek_inverter_state).state.c_str());
          it.printf(0, 70, id(roboto), "%.0f  W", id(marstek_battery_power).state);
      - id: page3
        lambda: |-
          it.printf(0, 40, id(roboto), "Remaining capacity");
          it.printf(0, 65, id(roboto), "%.1f kWh", id(marstek_remaining_capacity).state);    
      - id: page4
        lambda: |-
          it.printf(0, 10, id(roboto_small), "FW: %.0f", id(marstek_fw_version).state);
          it.printf(0, 20, id(roboto_small), "Temperature. %.0f C", id(marstek_internal_temperature).state);

# Configure UART
# WARNING For HW v0.1 GPIO12 is used for RX. This can lead to issues (strapping pin)
uart:
  - id: mod_bus
    rx_pin: GPIO12
    tx_pin: GPIO13
    baud_rate: 115200
    data_bits: 8
    stop_bits: 1
    parity: NONE

modbus:
  - uart_id: mod_bus
    id: modbus1
    send_wait_time: 200ms

modbus_controller:
  - id: mt
    address: 0x1
    modbus_id: modbus1
    command_throttle: 200ms
    update_interval: 5s

# Tekstsensoren
text_sensor:
  - name: "Marstek Device Name"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 31000
    register_count: 10
    response_size: 20
    skip_updates: 60 # 5 minutes

  # - name: "Marstek SN Code"
  #   platform: modbus_controller
  #   modbus_controller_id: mt
  #   register_type: holding
  #   address: 31200
  #   register_count: 10
  #   response_size: 20
  #   skip_updates: 60 # 5 minutes

  - platform: template
    name: "Marstek Inverter State"
    lambda: |-
      switch (int(id(inverter_state).state)) {
        case 0: return std::string("Sleep");
        case 1: return std::string("Standby");
        case 2: return std::string("Charge");
        case 3: return std::string("Discharge");
        case 4: return std::string("Fault");
        case 5: return std::string("Idle");
        default: return std::string("Unknown");
      };
    update_interval: 5s
    id: marstek_inverter_state

# Binaire sensoren
binary_sensor:
  - platform: modbus_controller
    name: "Marstek PLL Abnormal Restart"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x01
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Overtemperature Limit"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x02
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Low Temperature Limit"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x04
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Fan Abnormal Warning"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x08
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Low Battery SOC Warning"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x16
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Output Overcurrent Warning"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x32
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Abnormal Line Sequence Detection"
    modbus_controller_id: mt
    register_type: holding
    address: 36000
    bitmask: 0x64
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Wifi Abnormal"
    modbus_controller_id: mt
    register_type: holding
    address: 36001
    bitmask: 0x01
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BLE abnormal"
    modbus_controller_id: mt
    register_type: holding
    address: 36001
    bitmask: 0x02
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Network abnormal"
    modbus_controller_id: mt
    register_type: holding
    address: 36001
    bitmask: 0x04
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek CT connection abnormal"
    modbus_controller_id: mt
    register_type: holding
    address: 36001
    bitmask: 0x08
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Grid overvoltage"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x01
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Grid undervoltage"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x02
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Grid overfrequency"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x04
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Grid underfrequency"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x08
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Grid peak voltage abnormal"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x16
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Current Dcover"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x32
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek Voltage Dcover"
    modbus_controller_id: mt
    register_type: holding
    address: 36100
    bitmask: 0x64
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BAT overvoltage"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x01
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BAT undervoltage"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x02
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BAT overcurrent"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x04
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BAT low SOC"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x08
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BAT communication failure"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x16
    skip_updates: 6 # 30 seconds

  - platform: modbus_controller
    name: "Marstek BMS protect"
    modbus_controller_id: mt
    register_type: holding
    address: 36101
    bitmask: 0x32
    skip_updates: 6 # 30 seconds

 # - platform: status
 #   name: "WiFi Status"
 #   id: wifi_status

# Sensoren
sensor:
  - platform: modbus_controller
    id: inverter_state  # No name, since it's internal
    modbus_controller_id: mt
    register_type: holding
    address: 35100
    value_type: U_WORD
    internal: true # Hides from Home Assistant

  - name: "Marstek Firmware Version"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 31100
    value_type: U_WORD
    accuracy_decimals: 2
    skip_updates: 60 # 5 minutes
    id: marstek_fw_version

  - name: "Marstek Battery Voltage (Average)"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32100
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 2
    state_class: measurement
    filters:
      - multiply: 0.01
    skip_updates: 60 # 5 minutes
    
  - name: "Marstek Battery Current (Average)"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32101
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    accuracy_decimals: 2
    state_class: measurement
    filters:
      - multiply: 0.01

  - name: "Marstek Battery Power"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32102
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 2 # 10 seconds
    id: marstek_battery_power

  - name: "Marstek Battery State Of Charge"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32104
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 1
    id: marstek_soc
    skip_updates: 60 # 5 minutes

  - name: "Marstek Battery Total Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32105 
    value_type: U_WORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01 # Firmware 148: 0.001 / Firmware 147: 0.01
    id: marstek_total_energy
    skip_updates: 60 # 5 minutes

  - platform: template
    name: "Marstek Battery Remaining Capacity"
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    id: marstek_remaining_capacity
    update_interval: 300s
    lambda: |-
      if (id(marstek_total_energy).has_state() && id(marstek_soc).has_state()) {
        float total_energy = id(marstek_total_energy).state;
        float soc = id(marstek_soc).state / 100.0;
        return roundf(total_energy * soc * 100) / 100; // Ensures two decimal places
      }
      return NAN;

  - name: "Marstek AC Voltage"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32200
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 60 # 5 minutes

  - name: "Marstek AC Current"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32201
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  - name: "Marstek AC Power"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 32202
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: 2 # 10 seconds

#  - name: "Marstek AC Offgrid Voltage"
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32300
#    value_type: U_WORD
#    unit_of_measurement: "V"
#    device_class: voltage
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1
#    skip_updates: 60 # 5 minutes

#  - name: "Marstek AC Offgrid Current"
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32301
#    value_type: U_WORD
#    unit_of_measurement: "A"
#    device_class: current
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - name: "Marstek AC Offgrid Power"
#    platform: modbus_controller
#    modbus_controller_id: mt
#    register_type: holding
#    address: 32302
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 0

  - name: "Marstek Total Charging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33000
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Total Discharging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33002
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Daily Charging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33004
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Daily Discharging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33006
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Monthly Charging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33008
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Monthly Discharging Energy"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 33010
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    register_count: 2
    skip_updates: 60 # 5 minutes

  - name: "Marstek Internal Temperature"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35000
    value_type: S_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: 60 # 5 minutes
    id: marstek_internal_temperature

  - name: "Marstek Internal MOS1 Temperature"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35001
    value_type: S_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1
   
  - name: "Marstek Internal MOS2 Temperature"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35002
    value_type: S_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1

  - name: "Marstek Max. Cell Temperature"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35010
    value_type: S_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1
    
  - name: "Marstek Min. Cell Temperature"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35011
    value_type: S_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.1
    
  - name: "Marstek Battery Charge Voltage Limit"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35110
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    accuracy_decimals: 0
    state_class: measurement
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01

  - name: "Marstek Battery Charge Current Limit"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35111
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    accuracy_decimals: 0
    state_class: measurement
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01

  - name: "Marstek Battery Discharge Current Limit"
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 35112
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    accuracy_decimals: 0
    state_class: measurement
    skip_updates: 60 # 5 minutes
    filters:
      - multiply: 0.01

  #- platform: wifi_signal
  #  name: "WiFi Signal Strength"
  #  id: wifi_strength
  #  update_interval: 30s

  # An internal sensor to check Modbus communication status.
  - platform: modbus_controller
    modbus_controller_id: mt
    name: "Modbus Status"
    id: modbus_status
    register_type: holding
    address: 32104  # Using the Battery SOC register as a reference
    value_type: U_WORD
    internal: true

# Instellingen en modi (Select en Number)
select:
  - name: "Marstek RS485 Control Mode"
    icon: mdi:swap-horizontal
    platform: modbus_controller
    modbus_controller_id: mt
    address: 42000
    value_type: U_WORD
    optionsmap:
      "enable": 21930
      "disable": 21947
    skip_updates: 2 # 10 seconds

  - name: "Marstek Forcible Charge/Discharge" 
    platform: modbus_controller
    modbus_controller_id: mt
    address: 42010
    value_type: U_WORD
    optionsmap:
      "stop": 0
      "charge": 1
      "discharge": 2
    skip_updates: 2 # 10 seconds

  - name: "Marstek Backup Function"
    platform: modbus_controller
    modbus_controller_id: mt
    address: 41200
    value_type: U_WORD
    optionsmap:
      "enable": 0
      "disable": 1
    skip_updates: 2 # 10 seconds

  - name: "Marstek User Work Mode"
    icon: mdi:auto-mode
    platform: modbus_controller
    modbus_controller_id: mt
    address: 43000
    value_type: U_WORD
    optionsmap:
      "manual": 0
      "anti-feed": 1
      "ai": 2
    skip_updates: 2 # 10 seconds

number:
  - name: "Marstek Forcible Charge Power"
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42020
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds

  - name: "Marstek Charge To SOC"
    icon: mdi:battery-charging-medium 
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42011
    value_type: U_WORD
    unit_of_measurement: "%"
    min_value: 12
    max_value: 100
    step: 1

  - name: "Marstek Forcible Discharge Power"
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 42021
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds

  - name: "Marstek Charging Cutoff Capacity"
    icon: mdi:battery-90
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44000
    value_type: U_WORD
    unit_of_measurement: "%"
    min_value: 80
    max_value: 100
    multiply: 10
    skip_updates: 6 # 30 seconds

  - name: "Marstek Discharging Cutoff Capacity"
    icon: mdi:battery-10
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44001
    value_type: U_WORD
    unit_of_measurement: "%"
    min_value: 12
    max_value: 30
    multiply: 10
    skip_updates: 6 # 30 seconds

  - name: "Marstek Max. Charge Power"
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44002
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds

  - name: "Marstek Max. Discharge Power"
    icon: mdi:tune-variant
    mode: box
    platform: modbus_controller
    modbus_controller_id: mt
    register_type: holding
    address: 44003
    value_type: U_WORD
    unit_of_measurement: "W"
    min_value: 0
    max_value: 2500
    step: 1
    skip_updates: 2 # 10 seconds
